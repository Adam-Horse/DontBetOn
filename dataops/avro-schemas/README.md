# Avro IDL Models

This directory contains `templated` Avro IDL models for use between Kafka
consumers and producers.

Final processed `.avdl` and schema `.avsc` files are generated by the build 
script and placed into `build/output/avro`.

## Application Usage

Typically, an application will use the `Schema Registry` to encode and decode
Avro from a language-specific key-value object (like JSON).

While not required, it can be useful to generate language specific interfaces 
to support type checking and code generation.

Refer to below language examples for generating interfaces from Avro files.

### Typescript

The `@ovotech/avro-ts` package can be used to generate TypeScript interfaces
from AVSC files.

```typescript
    // Read and parse the AVSC schema to object
    const schemaContent = fs.readFileSync(SCHEMA_PATH, 'utf-8');
    const schema = JSON.parse(schemaContent);

    // Generate TypeScript code from the Avro schema
    const tsCode = toTypeScript(schema);

    // Show the exported TypeScript code
    console.log(tsCode);
```

This will produce a single output wrapped in a `namespace` block. The developer
can then save it to a single file or split it into multiple files.

Since TypeScript is used often in this project, interfaces are generated during
the build process and saved to `build/output/avro/typescript`.

### Python

The package [avro-to-python](https://avro-to-python.readthedocs.io/en/latest/)
can be used for generating Python classes from AVSC files.

## Templated IDL

Files with the `.template.avdl` extension are used to minimize changes when
updating model elements shared across multiple files.

This is accomplished by using the `@include` directive.

For example, the `httpRequest.avdl` file contains the following:

```avdl
namespace crawl;
schema HttpRequest;

record HttpRequest {
    /** HTTP method used in the request */
    string http_method;

    // @include {{ httpData.avdl }}
}
```

The `{{ httpData.avdl }}` directive is replaced with fields from the `HttpData`
record, which is defined in the `httpData.avdl` file.

```avdl
namespace crawl;
schema HttpData;

record HttpData {
    string uri;
    string http_version;
    map<string> headers;
    bytes? body;
}
```

When the `httpRequest.avdl` file is processed, the `@include` directive is
replaced with the following:

```avdl
namespace crawl;
schema HttpRequest;

record HttpRequest {
    /** HTTP method used in the request */
    string http_method;

    // imported from httpData.avdl
    string uri;
    string http_version;
    map<string> headers;
    bytes? body;

}
```

So any changes made to the `httpData.avdl` file will be reflected in any IDL 
files that includes the fields. 

This also supports nested records, for example `httpRequestOptions.avdl`:

```avdl
namespace crawl;
schema HttpRequestOptions;

record HttpRequestOptions { 
    // @include {{ httpRequest.template.avdl }}
}
```

The `@include` is replaced with `HttpRequest` fields, which contains and include
to `HttpData` fields. Producing a final result of:

```avdl
namespace crawl;
schema HttpRequestOptions;

record HttpRequestOptions { 
    // imported from httpRequest.template.avdl
    /** HTTP method used in the request */
    string http_method;

    // imported from httpData.avdl
    string uri;
    string http_version;
    map<string> headers;
    bytes? body;
}
```


